# 图形学实验 PA1: 光线投射 #

# 实现逻辑 #

1. `sceneParser` 解析输入文件, 得到: 相机参数, 物体列表, 光源列表, 背景色.
2. 遍历相机画幅 `img` 的每个像素
   - 计算出相机指向这个像素的出射光线 `ray`
   - 遍历物体列表, 寻找光线与最近一个物体的交点, 如果有, 记录为 `hit`
     - 若 `ray` 不与物体相交, 则直接设置此像素为背景色
     - 若得到了一个相交 `hit`, 则设置此像素为此相交处, 所有光源的 _Phong模型光照_ 
       之和
3. 最后将图片保存

## 计算出射光线 ##

光线的两个参数: 方向向量 & 出射点

出射点一定是相机中心, 关键在于求方向向量.

先计算相机坐标系下的出射向量, 再通过矩阵 $R = \begin{bmatrix} horizontal & -up & direction \end{bmatrix}$ 变换至实际坐标系.

由于是单位向量, 按像素的度量或实际坐标的度量均可计算, 下使用前者.

- 画幅中心 $imgc = [\cfrac {width} 2, \cfrac {height} 2]$
- 画幅与相机的距离 $dis = \cfrac {height} 2 \times 
\cfrac 1 {tan(angle / 2)}$

则相机坐标系下, 像素点 $p$ 对应的出射向量: $d_{cam} = [p_0 - imgc_0, imgc_1 - p_1, dis]$, 将其标准化.

则实际坐标系下的方向向量即 $R \cdot d_{cam}$.


## 求交 ##

以下计算的 `t` 均需做以下验证:
- `t > 0`
- 与给出的合法最小值 `tmin` 比较
- 与目前所得的最小值 `h.getT()` 比较, 取更小的 `t`, 目的是找到离相机最近的交点.

### 与平面 ###

联立平面和光线的方程, 解得:
$$t = -(D + n \cdot R_0) / (n \cdot R_d)$$
同上验证即可.

### 与三角形 ###

将三角形中的点使用重心坐标 $(\alpha, \beta, \gamma)$ 表示,
联立光线方程, 解出:
$$\begin{bmatrix} t \\ \beta \\ \gamma \end{bmatrix} = 
\cfrac 1 {det(R_d, E_1, E_2)} \begin{bmatrix} det(S, E_1, E_2) \\
det(R_d, S, E_2) \\ det(R_d, E_1, S) \end{bmatrix}$$

- 验证 $0 \le \beta, \gamma \le 1, \beta + \gamma \le 1$, 目的是保证交点在三角形内部.
- 再同上验证即可.

### 与球 ###

1. 计算相机到球心的向量 $l$
   (对比 $||l||$ 和 $r$, 确定相机在球外)
2. 计算球心到光线的投影点 $t_p = l \cdot R_d$
   验证 $t_p \le 0$, 目的是保证光线是射向球的
3. 计算球心到光线的距离 $d^2 = l^2 - t_p^2$
   验证 $d \le r$, 保证光线与球面相交
4. 计算 $t'^2 = r^2 - d^2$, 垂足到交点的距离
   本实验仅考虑相机在球外, $t = t_p - t'$

同上验证即可.

**注意点**: 进行仿射变换后, 光线的方向向量可能不是单位向量了, 求 `t_p` 时要注意缩放.

## Phong模型光照 ##

$I_{pixel} = \sum_i c_i (k_d clamp(L_i \cdot N) + k_s clamp(V \cdot R_i)^s)$

本次实验不考虑环境光项.

# 问题及解决 #

- 曾尝试用改进的弧长法判断三角形求交, 但未调试成功; 后使用原求解方程的方法,
  也遇到了计算过程写错的问题, 导致图像分崩离析, 最后更正过程, 问题解决.

# 交流与参考 #

- 与郭昊同学交流了关于出射光线计算中的比例问题, 即像素坐标的度量不同于实际坐标的度量.
- 除实验教程和课件外, 未参考任何代码/资料.

# Build & run #

```sh
$ cd code/
$ ./run_all.sh
```
在 `/code/outputs/` 中查看渲染结果.

# TODOs #

- 未有已发现而未能解决的bug.
- 如有更多时间, 希望实现更高效的三角形的求交算法.

